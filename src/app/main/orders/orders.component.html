<div class="orders-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <h1>My Bookings</h1>
          <p>Manage your tee time bookings and join requests</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container">
    <div class="row">
      <div class="col-12">
        <!-- Enhanced Statistics Dashboard (8 Cards) -->
        <div class="enhanced-stats-dashboard" *ngIf="!isLoading">
          <div class="row">
            <div class="col-xl-1-5 col-lg-3 col-md-6 col-sm-6 mb-3">
              <div class="stat-card total">
                <div class="stat-icon">
                  <fa-icon [icon]="calendarIcon"></fa-icon>
                </div>
                <div class="stat-content">
                  <h3>{{enhancedStatistics.total_bookings}}</h3>
                  <p>TOTAL BOOKINGS</p>
                </div>
              </div>
            </div>
            <div class="col-xl-1-5 col-lg-3 col-md-6 col-sm-6 mb-3">
              <div class="stat-card confirmed">
                <div class="stat-icon">
                  <fa-icon [icon]="checkCircleIcon"></fa-icon>
                </div>
                <div class="stat-content">
                  <h3>{{enhancedStatistics.confirmed}}</h3>
                  <p>CONFIRMED</p>
                </div>
              </div>
            </div>
            <div class="col-xl-1-5 col-lg-3 col-md-6 col-sm-6 mb-3">
              <div class="stat-card pending-sent">
                <div class="stat-icon">
                  <fa-icon [icon]="spinnerIcon"></fa-icon>
                </div>
                <div class="stat-content">
                  <h3>{{enhancedStatistics.pending_sent_requests}}</h3>
                  <p>PENDING SENT REQ.</p>
                </div>
              </div>
            </div>
            <div class="col-xl-1-5 col-lg-3 col-md-6 col-sm-6 mb-3">
              <div class="stat-card pending-received">
                <div class="stat-icon">
                  <fa-icon [icon]="exclamationTriangleIcon"></fa-icon>
                </div>
                <div class="stat-content">
                  <h3>{{enhancedStatistics.pending_received_requests}}</h3>
                  <p>PENDING REC. REQ.</p>
                </div>
              </div>
            </div>
            <div class="col-xl-1-5 col-lg-3 col-md-6 col-sm-6 mb-3">
              <div class="stat-card sent-accepted">
                <div class="stat-icon">
                  <fa-icon [icon]="checkIcon"></fa-icon>
                </div>
                <div class="stat-content">
                  <h3>{{enhancedStatistics.sent_requests_accepted}}</h3>
                  <p>SENT REQ. ACCPT.</p>
                </div>
              </div>
            </div>
            <div class="col-xl-1-5 col-lg-3 col-md-6 col-sm-6 mb-3">
              <div class="stat-card received-accepted">
                <div class="stat-icon">
                  <fa-icon [icon]="usersIcon"></fa-icon>
                </div>
                <div class="stat-content">
                  <h3>{{enhancedStatistics.received_requests_accepted}}</h3>
                  <p>RECEIVED REQ. ACCPT.</p>
                </div>
              </div>
            </div>
            <div class="col-xl-1-5 col-lg-3 col-md-6 col-sm-6 mb-3">
              <div class="stat-card rejected-received">
                <div class="stat-icon">
                  <fa-icon [icon]="banIcon"></fa-icon>
                </div>
                <div class="stat-content">
                  <h3>{{enhancedStatistics.rejected_received_requests}}</h3>
                  <p>REJECTED REC. REQ.</p>
                </div>
              </div>
            </div>
            <div class="col-xl-1-5 col-lg-3 col-md-6 col-sm-6 mb-3">
              <div class="stat-card rejected-sent">
                <div class="stat-icon">
                  <fa-icon [icon]="timesIcon"></fa-icon>
                </div>
                <div class="stat-content">
                  <h3>{{enhancedStatistics.rejected_sent_requests}}</h3>
                  <p>REJECTED SENT REQ.</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Enhanced Join Request Statistics -->
          <div class="row mt-4" *ngIf="joinRequestStatistics">
            <div class="col-12">
              <h4 class="section-title">Join Request Statistics</h4>
              <div class="row">
                <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                  <div class="stat-card incoming-pending">
                    <div class="stat-icon">
                      <fa-icon [icon]="exclamationTriangleIcon"></fa-icon>
                    </div>
                    <div class="stat-content">
                      <h3>{{joinRequestStatistics.incoming?.pending || 0}}</h3>
                      <p>Incoming Pending</p>
                    </div>
                  </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                  <div class="stat-card incoming-approved">
                    <div class="stat-icon">
                      <fa-icon [icon]="checkCircleIcon"></fa-icon>
                    </div>
                    <div class="stat-content">
                      <h3>{{joinRequestStatistics.incoming?.approved || 0}}</h3>
                      <p>Incoming Approved</p>
                    </div>
                  </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                  <div class="stat-card outgoing-pending">
                    <div class="stat-icon">
                      <fa-icon [icon]="exclamationTriangleIcon"></fa-icon>
                    </div>
                    <div class="stat-content">
                      <h3>{{joinRequestStatistics.outgoing?.pending || 0}}</h3>
                      <p>Outgoing Pending</p>
                    </div>
                  </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                  <div class="stat-card outgoing-approved">
                    <div class="stat-icon">
                      <fa-icon [icon]="checkCircleIcon"></fa-icon>
                    </div>
                    <div class="stat-content">
                      <h3>{{joinRequestStatistics.outgoing?.approved || 0}}</h3>
                      <p>Outgoing Approved</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Filter Controls -->
        <div class="filter-controls">
          <div class="row">
            <div class="col-md-6">
              <div class="filter-group">
                <label for="statusFilter">Filter by Status:</label>
                <select 
                  id="statusFilter" 
                  class="form-control" 
                  [(ngModel)]="selectedStatusFilter"
                  (change)="onStatusFilterChange($event.target.value)">
                  <option 
                    *ngFor="let filter of statusFilters" 
                    [value]="filter.value">
                    {{filter.label}} ({{filter.count}})
                  </option>
                </select>
              </div>
            </div>
            <div class="col-md-6 text-end">

              <button class="btn btn-outline-primary" (click)="refreshData()">
                <fa-icon [icon]="spinnerIcon" *ngIf="isLoading"></fa-icon>
                Refresh
              </button>
            </div>
          </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" *ngIf="isEmptyState() && !isLoading">
          <div class="text-center py-5">
            <div class="empty-icon mb-3">
              <fa-icon [icon]="calendarIcon" size="3x"></fa-icon>
            </div>
            <h3>No Bookings Found</h3>
            <p class="text-muted">You haven't made any bookings yet.</p>
            <button class="btn btn-primary" (click)="navigateToTeeBooking()">
              Book Tee Time
            </button>
          </div>
        </div>

        <!-- View Type Toggle - Separate Section -->
        <div class="view-toggle-section">
          <div class="d-flex justify-content-between align-items-center">
            <div class="toggle-info">
              <h6 class="mb-1">View Type</h6>
              <small class="text-muted">Switch between completed bookings and pending requests</small>
            </div>
            <div class="optimized-toggle-container">
              <div class="toggle-options">
                <button 
                  class="toggle-option" 
                  [class.active]="showBookingsOnly"
                  (click)="setViewType(true)">
                  <i class="fas fa-calendar-check me-2"></i>
                  My Bookings
                  <span class="count">{{getBookingsCount()}}</span>
                </button>
                <button 
                  class="toggle-option" 
                  [class.active]="!showBookingsOnly"
                  (click)="setViewType(false)">
                  <i class="fas fa-clock me-2"></i>
                  Pending Requests
                  <span class="count">{{getRequestsCount()}}</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Bookings Table -->
        <div class="bookings-table" *ngIf="!isEmptyState() && !isLoading">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>BOOKING ID</th>
                  <th>BOOKED DATE</th>
                  <th>COURSE NAME</th>
                  <th>TEE</th>
                  <th>SLOT DATE</th>
                  <th>SLOT TIME</th>
                  <th>PARTICIPANTS</th>
                  <th>STATUS</th>
                  <th>ACTION</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let booking of getPaginatedBookings()" [class]="getStatusClass(booking.status)">
                  <td>
                    <strong>{{booking.is_join_request ? (booking.request_id || booking.booking_id) : booking.booking_id}}</strong>
                    <span *ngIf="booking.hasMultipleSlots" class="badge badge-info ms-1">
                      Slot {{booking.slotNumber}}
                    </span>
                    <span *ngIf="booking.is_join_request" class="badge badge-warning ms-1">
                      Request
                    </span>
                  </td>
                  <td>{{formatDate(booking.createdAt)}}</td>
                  <td>{{booking.courseName}}</td>
                  <td>{{booking.teeName || booking.teeInfo}}</td>
                  <td>{{formatDate(booking.slotDate || booking.slot_date || booking.bookingDate)}}</td>
                  <td>{{booking.booking_time}}</td>
                  <td>
                    <span [class]="getStatusBadgeClass(booking)">
                      {{getParticipantDisplayText(booking)}}
                    </span>
                  </td>
                  <td>
                    <span [class]="getEnhancedStatusBadgeClass(booking)">
                      {{getEnhancedStatusDisplayText(booking)}}
                    </span>
                  </td>
                  <td>
                    <div class="btn-group" role="group">
                      <!-- Enhanced Action Buttons -->
                      <ng-container *ngIf="booking.displayType === 'received_request' && booking.statusType === 'RECEIVE REQUEST PENDING'">
                        <!-- Accept/Reject buttons for pending received requests -->
                        <button 
                          class="btn btn-sm btn-success me-1"
                          (click)="showConfirmationForApproval(booking)"
                          title="Accept Request">
                          <fa-icon [icon]="checkIcon" class="me-1"></fa-icon>
                          Accept
                        </button>
                        <button 
                          class="btn btn-sm btn-danger"
                          (click)="showConfirmationForRejection(booking)"
                          title="Reject Request">
                          <fa-icon [icon]="banIcon" class="me-1"></fa-icon>
                          Reject
                        </button>
                      </ng-container>
                      
                      <ng-container *ngIf="booking.displayType === 'own_booking' && booking.canAcceptMoreParticipants">
                        <!-- Add Participants button for own bookings -->
                        <button 
                          class="btn btn-sm btn-primary"
                          (click)="showAddParticipantsModal(booking)"
                          title="Add Participants">
                          <fa-icon class="me-1"></fa-icon>
                          Add Participants
                        </button>
                      </ng-container>
                      
                      <ng-container *ngIf="!(booking.displayType === 'received_request' && booking.statusType === 'RECEIVE REQUEST PENDING') && !(booking.displayType === 'own_booking' && booking.canAcceptMoreParticipants)">
                        <!-- View Details button for all other cases -->
                        <button 
                          class="btn btn-sm btn-secondary"
                          (click)="viewBookingDetails(booking)"
                          title="View Details">
                          <fa-icon [icon]="eyeIcon" class="me-1"></fa-icon>
                          View Details
                        </button>
                      </ng-container>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination Controls -->
          <div class="pagination-controls d-flex justify-content-between align-items-center mt-3" *ngIf="totalPages > 1">
            <div class="pagination-info">
              <span>Showing {{((currentPage - 1) * itemsPerPage) + 1}} to {{Math.min(currentPage * itemsPerPage, getFilteredBookings().length)}} of {{getFilteredBookings().length}} entries</span>
            </div>
            <nav aria-label="Page navigation">
              <ul class="pagination mb-0">
                <li class="page-item" [class.disabled]="currentPage === 1">
                  <button class="page-link" (click)="previousPage()" [disabled]="currentPage === 1">
                    Previous
                  </button>
                </li>
                <li class="page-item" 
                    *ngFor="let page of getPageNumbers()" 
                    [class.active]="page === currentPage">
                  <button class="page-link" (click)="goToPage(page)">
                    {{page}}
                  </button>
                </li>
                <li class="page-item" [class.disabled]="currentPage === totalPages">
                  <button class="page-link" (click)="nextPage()" [disabled]="currentPage === totalPages">
                    Next
                  </button>
                </li>
              </ul>
            </nav>
          </div>
        </div>

        <!-- Loading State -->
        <div class="loading-state text-center py-5" *ngIf="isLoading">
          <fa-icon [icon]="spinnerIcon" size="2x" class="fa-spin"></fa-icon>
          <p class="mt-3">Loading bookings...</p>
        </div>

        <!-- Error State -->
        <div class="error-state text-center py-5" *ngIf="errorMessage && !isLoading">
          <fa-icon [icon]="exclamationTriangleIcon" size="2x" class="text-danger"></fa-icon>
          <p class="mt-3 text-danger">{{errorMessage}}</p>
          <button class="btn btn-outline-primary" (click)="refreshData()">Try Again</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Participants Modal -->
<div class="modal fade" [class.show]="showParticipantModal" [style.display]="showParticipantModal ? 'block' : 'none'">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add More Participants</h5>
        <button type="button" class="btn-close" (click)="closeParticipantModal()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" *ngIf="selectedBookingForParticipants">
        <div class="booking-details mb-3">
          <p><strong>Course:</strong> {{selectedBookingForParticipants.courseName}}</p>
          <p><strong>Tee:</strong> {{selectedBookingForParticipants.teeName || selectedBookingForParticipants.teeInfo}}</p>
          <p><strong>Date:</strong> {{formatDate(selectedBookingForParticipants.slot_date || selectedBookingForParticipants.slotDate || selectedBookingForParticipants.bookingDate)}}</p>
          <p><strong>Time:</strong> {{selectedBookingForParticipants.booking_time}}</p>
          <p><strong>Current:</strong> {{selectedBookingForParticipants.participants}} participants</p>
          <p><strong>Available:</strong> {{4 - selectedBookingForParticipants.participants}} spots remaining</p>
        </div>
        
        <div class="form-group">
          <label for="participants">Add Participants:</label>
          <div class="input-group">
            <button type="button" class="btn btn-outline-secondary" (click)="decrementParticipants()">-</button>
            <input type="number" class="form-control text-center" 
                   [(ngModel)]="requestedParticipants" 
                   [min]="1" 
                   [max]="4 - selectedBookingForParticipants.participants"
                   readonly>
            <button type="button" class="btn btn-outline-secondary" (click)="incrementParticipants()">+</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeParticipantModal()">Cancel</button>
        <button type="button" class="btn btn-success" (click)="confirmAddParticipants()">
          <fa-icon class="me-1"></fa-icon>
          Add Participants
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Review Join Request Modal -->
<div class="modal fade" [class.show]="showJoinRequestModal" [style.display]="showJoinRequestModal ? 'block' : 'none'">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Review Join Request</h5>
        <button type="button" class="btn-close" (click)="closeReviewRequestModal()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" *ngIf="selectedJoinRequest">
        <div class="requester-info mb-3">
          <h6>Requester Information:</h6>
          <p><strong>Name:</strong> {{selectedJoinRequest.requesterName}}</p>
          <p><strong>Email:</strong> {{selectedJoinRequest.requesterEmail}}</p>
          <p><strong>Request Date:</strong> {{formatDate(selectedJoinRequest.createdAt || selectedJoinRequest.requestDate || selectedJoinRequest.formattedDate)}}</p>
          <p><strong>Request ID:</strong> {{selectedJoinRequest.request_id || selectedJoinRequest.booking_id}}</p>
        </div>
        
        <div class="original-booking-info mb-3">
          <h6>Original Booking Information:</h6>
          <p><strong>Original Booker:</strong> {{getOriginalBookerName(selectedJoinRequest)}}</p>
          <p><strong>Original Booking ID:</strong> {{selectedJoinRequest.originalBookingId}}</p>
          <p><strong>Original Booking Date:</strong> {{formatDate(selectedJoinRequest.originalBookingInfo?.createdAt || selectedJoinRequest.bookingDate)}}</p>
        </div>
        
        <div class="booking-details mb-3">
          <h6>Booking Details:</h6>
          <p><strong>Course:</strong> {{selectedJoinRequest.courseName}}</p>
          <p><strong>Tee:</strong> {{selectedJoinRequest.teeName || selectedJoinRequest.teeInfo}}</p>
          <p><strong>Date:</strong> {{formatDate(selectedJoinRequest.slot_date || selectedJoinRequest.slotDate || selectedJoinRequest.bookingDate)}}</p>
          <p><strong>Time:</strong> {{selectedJoinRequest.booking_time}}</p>
          <p><strong>Current Participants:</strong> {{getOriginalBookingParticipants(selectedJoinRequest)}} (Original Booking)</p>
          <p><strong>Requested Participants:</strong> {{selectedJoinRequest.participants}}</p>
          <p><strong>Total if Approved:</strong> {{getOriginalBookingParticipants(selectedJoinRequest) + selectedJoinRequest.participants}} participants</p>
        </div>
        
        <div class="form-group">
          <label>Action:</label>
          <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="reviewAction" id="approve" 
                   [(ngModel)]="reviewAction" value="approve" checked>
            <label class="btn btn-outline-success" for="approve">
              <fa-icon [icon]="checkIcon" class="me-1"></fa-icon>
              Approve
            </label>
            
            <input type="radio" class="btn-check" name="reviewAction" id="reject" 
                   [(ngModel)]="reviewAction" value="reject">
            <label class="btn btn-outline-danger" for="reject">
              <fa-icon [icon]="banIcon" class="me-1"></fa-icon>
              Reject
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeReviewRequestModal()">Cancel</button>
        <button type="button" 
                [class]="reviewAction === 'approve' ? 'btn-success' : 'btn-danger'"
                (click)="confirmReviewRequest()">
          <fa-icon [icon]="reviewAction === 'approve' ? checkIcon : banIcon" class="me-1"></fa-icon>
          {{reviewAction === 'approve' ? 'Approve' : 'Reject'}}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Booking Details Modal -->
<div class="modal fade" [class.show]="showBookingDetails" [style.display]="showBookingDetails ? 'block' : 'none'">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Booking Details</h5>
        <button type="button" class="btn-close" (click)="closeBookingDetails()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" *ngIf="selectedBooking">
        <div class="booking-info">
          <p><strong>Booking ID:</strong> {{selectedBooking.booking_id}}</p>
          <p><strong>Member ID:</strong> {{selectedBooking.memberGolfClubId || selectedBooking.requesterMemberId || 'N/A'}}</p>
          <p><strong>Status:</strong> 
            <span class="status-text">
              {{getStatusDisplayText(selectedBooking)}}
            </span>
          </p>
          <p><strong>Booked Date:</strong> {{formatDate(selectedBooking.createdAt)}}</p>
          <p><strong>Course:</strong> {{selectedBooking.courseName}}</p>
          <p><strong>Tee:</strong> {{selectedBooking.teeName || selectedBooking.teeInfo}}</p>
          <p><strong>Slot Date:</strong> {{formatDate(selectedBooking.slot_date || selectedBooking.slotDate || selectedBooking.bookingDate)}}</p>
          <p><strong>Slot Time:</strong> {{selectedBooking.booking_time}}</p>
          <p><strong>Participants:</strong> {{getParticipantDisplayText(selectedBooking)}}</p>
          
          <!-- Show detailed participant information for merged bookings -->
          <div *ngIf="selectedBooking.allParticipantsInfo && selectedBooking.allParticipantsInfo.length > 0" class="mt-4">
            <h6 class="mb-3">
              <i class="fas fa-users me-2"></i>
              {{selectedBooking.allParticipantsInfo.length > 1 ? 'All Participants' : 'Participant Details'}}
            </h6>
            <div class="participants-list">
              <div *ngFor="let participant of selectedBooking.allParticipantsInfo; let i = index" 
                   class="participant-card mb-3 p-3 border rounded shadow-sm">
                
                <!-- Participant Header -->
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div class="participant-info">
                    <h6 class="mb-1">
                      <i class="fas fa-user me-2"></i>
                      {{participant.member_name}}
                    </h6>
                    <span class="badge me-2" 
                          [class]="participant.is_original_booker ? 'badge-primary' : 'badge-success'">
                      {{participant.is_original_booker ? 'Original Booker' : 'Joined Member'}}
                    </span>
                    <span class="badge badge-info">
                      Member ID: {{participant.member_id}}
                    </span>
                  </div>
                  <div class="participant-count">
                    <span class="badge badge-secondary fs-6">
                      {{participant.participants}} participant{{participant.participants > 1 ? 's' : ''}}
                    </span>
                  </div>
                </div>

                <!-- Additional Details for Joined Members -->
                <div *ngIf="!participant.is_original_booker" class="joined-member-details mt-2">
                  <div class="row">
                    <div class="col-md-6" *ngIf="participant.approved_at">
                      <small class="text-muted">
                        <i class="fas fa-check-circle me-1 text-success"></i>
                        Approved: {{formatDate(participant.approved_at)}}
                      </small>
                    </div>
                    <div class="col-md-6" *ngIf="participant.join_request_id">
                      <small class="text-muted">
                        <i class="fas fa-link me-1"></i>
                        Request ID: {{participant.join_request_id}}
                      </small>
                    </div>
                  </div>
                </div>

                <!-- Original Booker Details -->
                <div *ngIf="participant.is_original_booker" class="original-booker-details mt-2">
                  <small class="text-muted">
                    <i class="fas fa-crown me-1 text-warning"></i>
                    Booking Owner - Created this booking
                  </small>
                </div>
              </div>
            </div>

            <!-- Booking Summary -->
            <div class="booking-summary mt-3 p-3 bg-light rounded">
              <div class="row">
                <div class="col-md-4">
                  <strong>Total Participants:</strong>
                  <span class="ms-2">{{selectedBooking.participants}}</span>
                </div>
                <div class="col-md-4" *ngIf="selectedBooking.maxParticipants">
                  <strong>Max Capacity:</strong>
                  <span class="ms-2">{{selectedBooking.maxParticipants}}</span>
                </div>
                <div class="col-md-4" *ngIf="selectedBooking.availableSpots !== undefined">
                  <strong>Available Spots:</strong>
                  <span class="ms-2 badge" 
                        [class]="selectedBooking.availableSpots > 0 ? 'badge-success' : 'badge-warning'">
                    {{selectedBooking.availableSpots}}
                  </span>
                </div>
              </div>
            </div>
          </div>
          
                     <div *ngIf="selectedBooking.hasMultipleSlots" class="mt-3">
             <h6>Multi-Slot Booking:</h6>
             <p>This is part of a {{selectedBooking.totalSlots}}-slot booking (Slot {{selectedBooking.slotNumber}})</p>
           </div>
           

           
                     <!-- Enhanced Member Details for Request Records -->
          <div *ngIf="selectedBooking.is_join_request || selectedBooking.isIncomingRequest" class="mt-4">
            <h6 class="mb-3">
              <i class="fas fa-users me-2"></i>
              Member Information
            </h6>
            
            <!-- Request Member Details -->
            <div class="member-details-card request-member mb-3">
              <div class="member-card-header">
                <div class="member-icon">
                  <i class="fas fa-user-plus"></i>
                </div>
                <div class="member-title">
                  <h6 class="mb-1">Request Member</h6>
                  <span class="member-subtitle">Member who requested to join</span>
                </div>
              </div>
              <div class="member-card-content">
                <div class="row">
                  <div class="col-md-6">
                    <div class="member-info-item">
                      <i class="fas fa-user"></i>
                      <div class="info-content">
                        <span class="info-label">Name</span>
                        <span class="info-value">{{selectedBooking.requesterName || selectedBooking.memberName || selectedBooking.memberFullName || 'Unknown Member'}}</span>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="member-info-item">
                      <i class="fas fa-id-card"></i>
                      <div class="info-content">
                        <span class="info-label">Member ID</span>
                        <span class="info-value">{{selectedBooking.requesterMemberId || selectedBooking.memberGolfClubId || 'N/A'}}</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="member-info-item">
                      <i class="fas fa-calendar-alt"></i>
                      <div class="info-content">
                        <span class="info-label">Request Date</span>
                        <span class="info-value">{{formatDate(selectedBooking.createdAt || selectedBooking.requestDate || selectedBooking.formattedDate)}}</span>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="member-info-item">
                      <i class="fas fa-users"></i>
                      <div class="info-content">
                        <span class="info-label">Requested Participants</span>
                        <span class="info-value">{{selectedBooking.participants}} participant{{selectedBooking.participants > 1 ? 's' : ''}}</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row" *ngIf="selectedBooking.requesterEmail">
                  <div class="col-md-6">
                    <div class="member-info-item">
                      <i class="fas fa-envelope"></i>
                      <div class="info-content">
                        <span class="info-label">Email</span>
                        <span class="info-value">{{selectedBooking.requesterEmail}}</span>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="member-info-item">
                      <i class="fas fa-hashtag"></i>
                      <div class="info-content">
                        <span class="info-label">Request ID</span>
                        <span class="info-value">{{selectedBooking.request_id || selectedBooking.booking_id}}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Accepting Member Details (Original Booker) -->
            <div class="member-details-card accepting-member mb-3" *ngIf="selectedBooking.originalBookerName || selectedBooking.originalBookerId">
              <div class="member-card-header">
                <div class="member-icon">
                  <i class="fas fa-user-check"></i>
                </div>
                <div class="member-title">
                  <h6 class="mb-1">Accepting Member</h6>
                  <span class="member-subtitle">Original booker who can accept/reject</span>
                </div>
              </div>
              <div class="member-card-content">
                <div class="row">
                  <div class="col-md-6">
                    <div class="member-info-item">
                      <i class="fas fa-user"></i>
                      <div class="info-content">
                        <span class="info-label">Name</span>
                        <span class="info-value">{{selectedBooking.originalBookerName || 'Original Booker'}}</span>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="member-info-item">
                      <i class="fas fa-id-card"></i>
                      <div class="info-content">
                        <span class="info-label">Member ID</span>
                        <span class="info-value">{{selectedBooking.originalBookerId || selectedBooking.memberGolfClubId || 'N/A'}}</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="member-info-item">
                      <i class="fas fa-crown"></i>
                      <div class="info-content">
                        <span class="info-label">Role</span>
                        <span class="info-value">Original Booking Owner</span>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6" *ngIf="selectedBooking.approvedBy || selectedBooking.approvedAt">
                    <div class="member-info-item">
                      <i class="fas fa-check-circle"></i>
                      <div class="info-content">
                        <span class="info-label">Action Date</span>
                        <span class="info-value">{{formatDate(selectedBooking.approvedAt)}}</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row" *ngIf="selectedBooking.originalBookingId">
                  <div class="col-md-6">
                    <div class="member-info-item">
                      <i class="fas fa-link"></i>
                      <div class="info-content">
                        <span class="info-label">Original Booking ID</span>
                        <span class="info-value">{{selectedBooking.originalBookingId}}</span>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6" *ngIf="selectedBooking.currentSlotStatus">
                    <div class="member-info-item">
                      <i class="fas fa-info-circle"></i>
                      <div class="info-content">
                        <span class="info-label">Current Participants</span>
                        <span class="info-value">{{selectedBooking.currentSlotStatus.currentParticipants}} / {{selectedBooking.currentSlotStatus.maxParticipants}}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Request Status Information -->
            <div class="request-status-card">
              <div class="status-header">
                <i class="fas fa-info-circle me-2"></i>
                Request Status Information
              </div>
              <div class="status-content">
                <div class="row">
                  <div class="col-md-4">
                    <div class="status-item">
                      <span class="status-label">Current Status</span>
                      <span class="status-value" [class]="getStatusBadgeClass(selectedBooking)">
                        {{getStatusDisplayText(selectedBooking)}}
                      </span>
                    </div>
                  </div>
                  <div class="col-md-4" *ngIf="selectedBooking.totalParticipantsIfApproved">
                    <div class="status-item">
                      <span class="status-label">Total If Approved</span>
                      <span class="status-value">{{selectedBooking.totalParticipantsIfApproved}} participants</span>
                    </div>
                  </div>
                  <div class="col-md-4" *ngIf="selectedBooking.currentSlotStatus">
                    <div class="status-item">
                      <span class="status-label">Available Spots</span>
                      <span class="status-value" [class]="selectedBooking.currentSlotStatus.availableSlots > 0 ? 'text-success' : 'text-warning'">
                        {{selectedBooking.currentSlotStatus.availableSlots}} remaining
                      </span>
                    </div>
                  </div>
                </div>
              </div>
             </div>
           </div>
           
           <!-- Show accept/reject buttons for incoming join requests -->
           <div *ngIf="selectedBooking.isIncomingRequest && selectedBooking.status === 'pending_approval'" class="mt-4">
             <h6>Join Request Action:</h6>
             <div class="d-flex gap-2 mt-3">
               <button 
                 class="btn btn-success"
                 (click)="handleAcceptRequest(selectedBooking)"
                 [disabled]="!canAcceptRequest(selectedBooking)">
                 <fa-icon [icon]="checkIcon" class="me-1"></fa-icon>
                 Accept Request
               </button>
               <button 
                 class="btn btn-danger"
                 (click)="handleRejectRequest(selectedBooking)">
                 <fa-icon [icon]="banIcon" class="me-1"></fa-icon>
                 Reject Request
               </button>
             </div>
             <div *ngIf="!canAcceptRequest(selectedBooking)" class="alert alert-warning mt-2">
               <small>Cannot accept: Slot would exceed maximum participants (4)</small>
             </div>
           </div>
         </div>
       </div>
       <div class="modal-footer">
         <button type="button" class="btn btn-secondary" (click)="closeBookingDetails()">Close</button>
       </div>
    </div>
  </div>
</div>

<!-- Pending Review Modal -->
<div class="modal fade" [class.show]="showPendingReviewModal" [style.display]="showPendingReviewModal ? 'block' : 'none'">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Pending Review Requests</h5>
        <button type="button" class="btn-close" (click)="closePendingReviewModal()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div *ngIf="pendingReviewRequests.length === 0" class="text-center py-4">
          <p class="text-muted">No pending review requests found.</p>
        </div>
        
        <div *ngIf="pendingReviewRequests.length > 0" class="review-requests-list">
          <div *ngFor="let request of pendingReviewRequests" class="review-request-item mb-4 p-3 border rounded">
            <div class="row">
              <div class="col-md-8">
                <h6 class="mb-2">{{request.memberName}} wants to join your slot</h6>
                <div class="request-details">
                  <p><strong>Course:</strong> {{request.courseName}}</p>
                  <p><strong>Tee:</strong> {{request.teeName || request.teeInfo || request.teeHoles}}</p>
                  <p><strong>Date:</strong> {{formatDate(request.slotDate)}}</p>
                  <p><strong>Time:</strong> {{request.bookingTime}}</p>
                  <p><strong>Requested Participants:</strong> {{request.participants}}</p>
                  <p><strong>Your Current Participants:</strong> {{request.originalBookingParticipants}}</p>
                  <p><strong>Available Spots:</strong> {{request.availableSpots}}</p>
                  <p><strong>Request Date:</strong> {{formatDate(request.createdAt)}}</p>
                </div>
              </div>
              <div class="col-md-4 text-end">
                <div class="action-buttons">
                  <button 
                    class="btn btn-success btn-sm mb-2 w-100"
                    (click)="handlePendingReviewAction(request, 'approve')"
                    [disabled]="!request.canApprove">
                    <fa-icon [icon]="checkIcon" class="me-1"></fa-icon>
                    Approve
                  </button>
                  <button 
                    class="btn btn-danger btn-sm w-100"
                    (click)="handlePendingReviewAction(request, 'reject')">
                    <fa-icon [icon]="banIcon" class="me-1"></fa-icon>
                    Reject
                  </button>
                </div>
                <div *ngIf="!request.canApprove" class="text-danger small mt-2">
                  Slot cannot accommodate additional participants
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closePendingReviewModal()">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Join Request Review Modal -->
<div class="modal fade" [class.show]="showJoinRequestModal" [style.display]="showJoinRequestModal ? 'block' : 'none'">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Review Join Request</h5>
        <button type="button" class="btn-close" (click)="closeReviewRequestModal()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" *ngIf="selectedJoinRequest">
        <div class="request-info">
          <h6>Request ID: {{selectedJoinRequest.requestId}}</h6>
          
          <div class="row mt-3">
            <div class="col-md-6">
              <h6>Requester Information:</h6>
              <p><strong>Name:</strong> {{selectedJoinRequest.requesterName}}</p>
              <p><strong>Member ID:</strong> {{selectedJoinRequest.requesterMemberId}}</p>
              <p><strong>Request Date:</strong> {{formatDate(selectedJoinRequest.requestDate)}}</p>
            </div>
            <div class="col-md-6">
              <h6>Booking Details:</h6>
              <p><strong>Course:</strong> {{selectedJoinRequest.courseName}}</p>
              <p><strong>Tee:</strong> {{selectedJoinRequest.teeName || selectedJoinRequest.teeInfo || selectedJoinRequest.tee}}</p>
              <p><strong>Date:</strong> {{formatDate(selectedJoinRequest.slotDate || selectedJoinRequest.slot_date || selectedJoinRequest.bookingDate)}}</p>
              <p><strong>Time:</strong> {{selectedJoinRequest.slotTime}}</p>
            </div>
          </div>
          
          <div class="slot-status mt-4" *ngIf="selectedJoinRequest.currentSlotStatus">
            <h6>Current Slot Status:</h6>
            <div class="row">
              <div class="col-md-6">
                <p><strong>Your Participants:</strong> {{selectedJoinRequest.currentSlotStatus.currentParticipants}}</p>
                <p><strong>Requested Participants:</strong> {{selectedJoinRequest.requestedParticipants}}</p>
              </div>
              <div class="col-md-6">
                <p><strong>Total if Approved:</strong> {{selectedJoinRequest.totalParticipantsIfApproved}}/4 participants</p>
                <p><strong>Remaining Slots:</strong> {{selectedJoinRequest.remainingSlotsIfApproved}}</p>
              </div>
            </div>
          </div>
          
          <div class="other-requests mt-4" *ngIf="selectedJoinRequest.otherPendingRequests && selectedJoinRequest.otherPendingRequests.length > 0">
            <h6>⚠️ Other Pending Requests: {{selectedJoinRequest.otherPendingRequests.length}}</h6>
            <div class="other-requests-list">
              <div *ngFor="let otherRequest of selectedJoinRequest.otherPendingRequests" class="other-request-item p-2 border rounded mb-2">
                <small>
                  <strong>{{otherRequest.requesterName}}</strong> - {{otherRequest.requestedParticipants}} participant(s) 
                  ({{formatDate(otherRequest.requestDate)}})
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" (click)="handleReviewRequest('reject')">
          <fa-icon [icon]="banIcon" class="me-1"></fa-icon>
          Reject
        </button>
        <button type="button" class="btn btn-success" (click)="handleReviewRequest('approve')">
          <fa-icon [icon]="checkIcon" class="me-1"></fa-icon>
          Approve
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<!-- Confirmation Modal -->
<div class="modal fade" [class.show]="showConfirmationModal" [style.display]="showConfirmationModal ? 'block' : 'none'">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-question-circle me-2 text-warning"></i>
          Confirm {{confirmationAction === 'approve' ? 'Approval' : 'Rejection'}}
        </h5>
        <button type="button" class="btn-close" (click)="closeConfirmationModal()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" *ngIf="confirmationRequest">
        <div class="alert alert-info">
          <div class="row">
            <div class="col-md-6">
              <strong>Requester:</strong><br>
              {{confirmationRequest.requesterName || confirmationRequest.memberName || confirmationRequest.memberFullName}}
              <div *ngIf="confirmationRequest.requesterMemberId" class="mt-1">
                <small class="text-muted">
                  <i class="fas fa-id-card me-1"></i>
                  Member ID: {{confirmationRequest.requesterMemberId}}
                </small>
              </div>
            </div>
            <div class="col-md-6">
              <strong>Participants:</strong><br>
              {{confirmationRequest.requestedParticipants || confirmationRequest.participants}} participant{{(confirmationRequest.requestedParticipants || confirmationRequest.participants) > 1 ? 's' : ''}}
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-md-6">
              <strong>Course:</strong><br>
              {{confirmationRequest.courseName}}
            </div>
            <div class="col-md-6">
              <strong>Date & Time:</strong><br>
              {{confirmationRequest.slotDate || confirmationRequest.bookingDate}} at {{confirmationRequest.slotTime || confirmationRequest.bookingTime}}
            </div>
          </div>
        </div>
        
        <div class="confirmation-message text-center">
          <p class="mb-3">
            <strong>
              Are you sure you want to {{confirmationAction === 'approve' ? 'approve' : 'reject'}} this join request?
            </strong>
          </p>
          <div *ngIf="confirmationAction === 'approve'" class="text-success">
            <i class="fas fa-check-circle me-2"></i>
            This will add {{confirmationRequest.requestedParticipants}} participant{{confirmationRequest.requestedParticipants > 1 ? 's' : ''}} to your booking.
          </div>
          <div *ngIf="confirmationAction === 'reject'" class="text-danger">
            <i class="fas fa-times-circle me-2"></i>
            This request will be permanently rejected.
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeConfirmationModal()">
          Cancel
        </button>
        <button 
          type="button" 
          class="btn"
          [class]="confirmationAction === 'approve' ? 'btn-success' : 'btn-danger'"
          (click)="confirmAction()">
          <i class="fas" [class]="confirmationAction === 'approve' ? 'fa-check' : 'fa-times'" class="me-2"></i>
          {{confirmationAction === 'approve' ? 'Approve Request' : 'Reject Request'}}
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop fade show" *ngIf="showParticipantModal || showJoinRequestModal || showBookingDetails || showPendingReviewModal || showJoinRequestModal || showConfirmationModal"></div>
